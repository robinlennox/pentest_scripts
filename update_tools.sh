###############################################################################
# Update Tools - by Robin Lennox #
###############################################################################

#!/bin/sh

#Global Variables
TOOLSDIRECTORY=~/Desktop/tools
HIGHLIGHT="#############################################################"

# Function
PRINT_MESSAGE(){
	exec >/dev/tty
	echo '\n'"`tput bold``tput setf 1`[*]`tput sgr0` $1"
	exec 1>/dev/null 2>/dev/null
}

PRINT_GOOD(){
	exec >/dev/tty
	echo "`tput bold``tput setf 2`[*]`tput sgr0` $1"
	exec 1>/dev/null 2>/dev/null
}

PRINT_ERROR(){
	exec >/dev/tty
	echo "`tput bold``tput setf 4`[*]`tput sgr0` $1"
	exec 1>/dev/null 2>/dev/null
}

PRINT_QUESTION(){
	exec >/dev/tty
	echo '\n'"`tput bold``tput setf 6`${HIGHLIGHT}`tput sgr0`"
	echo -n "`tput bold``tput setf 6`[*]`tput sgr0` $1"
	exec 1>/dev/null 2>/dev/null
}

# Internet Connectivity
PRINT_MESSAGE "Verifying Internet Connectivity"
curl google.com -m 5 2>&1 | grep -o "timed out"
if [ $? != 0 ] ; then
	PRINT_GOOD "Internet Connection Working"
else
	PRINT_ERROR "Internet Connection Timeout"
	exit
fi

# Disable GNOME Keyring Control
unset GNOME_KEYRING_CONTROL

PRINT_MESSAGE "Update Tools Script"

# Make sure script is not run as root
if [ "$(id -u)" = "0" ]; then
   PRINT_ERROR "This script must not be run as root" 1>&2
   exit
fi

# Check if user can sudo
PRINT_GOOD "Prompt for Sudo Password"
sudo uptime
if [ $? != 0 ]; then
	PRINT_ERROR "Sudo Password not entered, exiting script."
	exit
fi

# Script prerequisites
for DEPENDPKG in build-essential curl git make subversion
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Script Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# Update Ubuntu
PRINT_MESSAGE "Checking for Ubuntu updates"

#Don't accept changes to configuration file
echo N | sudo dpkg --configure -a

#Distro Upgrade
sudo apt-get dist-upgrade -y
sudo apt-get autoclean -y
sudo apt-get autoremove -y

sudo apt-get update
PACKAGES_KEPT_BACK=$(sudo apt-get -y upgrade | tail -1  | grep -Eo '[1-9] not upgraded')
UPDATE_INSTALLED=$(sudo apt-get -y upgrade | cut -d ' ' -f1-5 | grep -Eo '[1-9]')
if [ -z ! "$PACKAGES_KEPT_BACK" ] ; then
	PRINT_ERROR "Ubuntu can not update packages"
	PRINT_ERROR "Possible Distro-Update needed"
elif [ "$UPDATE_INSTALLED" = 0 ] ; then
	PRINT_GOOD "Ubuntu updated"
else
	PRINT_GOOD "Ubuntu already up-to-date"
fi

# Update Gem
PRINT_MESSAGE "Checking for Gem updates"

for DEPENDPKG in rubygems-update
do
	gem list ${DEPENDPKG} | grep ${DEPENDPKG}
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Gem Update Dependency - ${DEPENDPKG}"
		sudo gem install ${DEPENDPKG}
	fi
done

sudo update_rubygems --no-document
sudo gem update --system | grep -o Latest
if [ $? = 0 ] ; then
	PRINT_GOOD "Gems already up-to-date"
else
	PRINT_GOOD "Gems updated"
fi

# Install SQLmap
PRINT_MESSAGE "Checking for SQLmap updates"
cd "${TOOLSDIRECTORY}"
if [ ! -d ./sqlmap-dev/ ]; then
	PRINT_GOOD "Downloading SQLmap"
	git clone https://github.com/sqlmapproject/sqlmap.git ${TOOLSDIRECTORY}/sqlmap-dev
else
	cd ./sqlmap-dev/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "SQLMap already up-to-date"
	else
		PRINT_GOOD "SQLMap updated"
	fi
fi

# SQLmap Dependencies
for DEPENDPKG in python-kinterbasdb python-pyodbc python-pymssql python-psycopg2 python-pysqlite2 python-pymssql python-dbg
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install SQLmap Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# Responder
PRINT_MESSAGE "Checking for Responder updates"
cd "${TOOLSDIRECTORY}"
if [ ! -d ./responder/ ]; then
	PRINT_GOOD "Downloading Responder"
	git clone https://github.com/SpiderLabs/Responder.git responder
else
	cd ./responder/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "Responder already up-to-date"
	else
		PRINT_GOOD "Responder updated"
	fi
fi

# Responder Dependencies
for DEPENDPKG in python-openssl
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Responder Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# Nikto
PRINT_MESSAGE "Checking for Nikto updates"
cd "${TOOLSDIRECTORY}"
if [ ! -d ./nikto/ ]; then
	PRINT_GOOD "Downloading Nikto"
	git clone https://github.com/sullo/nikto.git nikto
else
	cd ./nikto/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "Nikto already up-to-date"
	else
		PRINT_GOOD "Nikto updated"
	fi

	# Update Database and plugins... I assume the github repo will be up-to-date so this won't need to done.
	#./program/nikto.pl -update
fi

# WebSploit Dependencies
for DEPENDPKG in python-scapy
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install WebSploit Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# WebSploit
PRINT_MESSAGE "Checking for WebSploit updates"
cd "${TOOLSDIRECTORY}"
if [ ! -d ./websploit/ ]; then
	PRINT_GOOD "Downloading WebSploit"
	git clone https://github.com/websploit/websploit.git
else
	cd ./websploit/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "WebSploit already up-to-date"
	else
		PRINT_GOOD "WebSploit updated"
	fi

fi

# dirs3arch Dependencies
for DEPENDPKG in python3
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install dirs3arch Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# dirs3arch
PRINT_MESSAGE "Checking for dirs3arch updates"
cd "${TOOLSDIRECTORY}"
if [ ! -d ./websploit/ ]; then
	PRINT_GOOD "Downloading dirs3arch"
	git clone https://github.com/maurosoria/dirs3arch.git
else
	cd ./websploit/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "dirs3arch already up-to-date"
	else
		PRINT_GOOD "dirs3arch updated"
	fi
fi

# Nmap Dependencies
PRINT_MESSAGE "Checking for Nmap updates"
for DEPENDPKG in autoconf build-essential libssl-dev liblinear-dev libpcap0.8-dev libpcre3-dev binutils-dev liblua5.2-dev
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Nmap Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

# NMap SVN #
#Local Variables
NMAPLOCATION="https://svn.nmap.org/nmap"
REMOTEVERSION=`svn info ${NMAPLOCATION} | grep Revision | cut -f 2 -d:`
LOCALVERSION=`svn info ${TOOLSDIRECTORY}/nmap/ | grep Revision | cut -f 2 -d:`
EXIST=`which nmap | grep nmap`
#NMap Install Function
nmap_install()
{
		PRINT_GOOD "Downloading Nmap"
		svn co ${NMAPLOCATION}
		cd ./nmap/
		./configure
		make
		sudo make install clean
}
cd ${TOOLSDIRECTORY}
if [ ! -d ./nmap/ ]; then
	nmap_install
elif [ "$EXIST" = "" ]; then
	PRINT_ERROR "NMap not installed. This needs to be redownloaded and complied"
	rm -rf ./nmap/
	nmap_install
elif [ "${LOCALVERSION}" -lt "${REMOTEVERSION}" ]; then #If Revision numbers
	PRINT_ERROR "Running old Nmap"
	cd "${TOOLSDIRECTORY}"/nmap
	PRINT_GOOD "Uninstalling old Nmap"
	sudo make uninstall
	svn up
	nmap_install
	PRINT_GOOD "Nmap updated"
else
	PRINT_GOOD "Nmap already up-to-date"
fi

# Metasploit
PRINT_MESSAGE "Checking for Metasploit updates"
# Metasploit Dependencies
for DEPENDPKG in build-essential libreadline-dev libssl-dev libpq5 libpq-dev libreadline5 libsqlite3-dev libpcap-dev openjdk-7-jre subversion git-core autoconf postgresql curl zlib1g-dev libxml2-dev libxslt1-dev xtightvncviewer libyaml-dev ruby-dev
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Metasploit Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

for DEPENDPKG in wirble sqlite3 bundler pcaprub nokogiri
do
	gem list ${DEPENDPKG} | grep ${DEPENDPKG}
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install Metasploit Gem Dependency - ${DEPENDPKG}"
		sudo gem install ${DEPENDPKG}
	fi
done

# Install Metasploit
cd /opt/
if [ ! -d ./metasploit-framework/ ]; then
	PRINT_GOOD "Downloading Metasploit"
	sudo git clone https://github.com/rapid7/metasploit-framework.git
	cd metasploit-framework/
	sudo bash -c 'for MSF in $(ls msf*); do ln -s /opt/metasploit-framework/${MSF} /usr/local/bin/${MSF};done'
	bundle install

	# Stops: WARNING: Nokogiri was built against LibXML version
	sudo gem pristine nokogiri

	PRINT_QUESTION "Enter password for MSF Postgres user [ENTER]: "
	read MSFPASS

	# Creating the MSF Database user msf with the password provided
	sudo -u postgres psql postgres -c "create role msf login password '${MSFPASS}'"

	# Creating msf database and setting the owner to msf user
	sudo -u postgres psql postgres -c "CREATE DATABASE msf OWNER msf;"

	POSTGRES_PORT=`cat /etc/postgresql/*/main/postgresql.conf | awk -F "port = " '{print $2}' | awk '{print $1}' | tr -s '\n' ' ' | tr -d ' '`
	sudo sh -c "echo 'production:
   adapter: postgresql
   database: msf
   username: msf
   password: ${MSFPASS}
   host: 127.0.0.1
   port: ${POSTGRES_PORT}
   pool: 75
   timeout: 5' > /opt/metasploit-framework/database.yml"

	sudo sh -c "echo export MSF_DATABASE_CONFIG=/opt/metasploit-framework/database.yml >> /etc/profile"

	cd /etc/postgresql/*/main/
	sudo cp ./postgresql.conf ./postgresql.conf_orig
	sudo sed -i -e 's/ssl = true/#ssl = true/g' ./postgresql.conf

	sudo cp ./pg_hba.conf ./pg_hba.conf_orig
	sudo sh -c "echo '# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   msf             msf                                     trust
# IPv4 local connections:
host    msf             msf             127.0.0.1/32            trust
# IPv6 local connections:
host    msf             msf             ::1/128                 trust
# Allow replication connections from localhost, by a user with the
# replication privilege.
#local   replication     postgres                                peer
#host    replication     postgres        127.0.0.1/32            md5
#host    replication     postgres        ::1/128                 md5
' > ./pg_hba.conf"

	sudo /etc/init.d/postgresql restart
	echo "alias msfconsole='-E msfconsole -d db_connect -y /opt/metasploit-framework/database.yml'" >> ~/.oh-my-zsh/custom/zsh_aliases.plugin.zsh
	echo "alias sudo='sudo '" >> ~/.oh-my-zsh/custom/zsh_aliases.plugin.zsh
	PRINT_ERROR "Please logout before using Metasploit"
else
	cd ./metasploit-framework/
	sudo git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "Metasploit already up-to-date"
	else
		# Update any missing Gems
		sudo bundle install
		PRINT_GOOD "Metasploit updated"
	fi
fi

# Armitage
PRINT_MESSAGE "Checking for Armitage updates"
cd /usr/local/share/
if [ ! -d ./armitage/ ]; then
	PRINT_GOOD "Downloading Armitage"
	sudo svn checkout http://armitage.googlecode.com/svn/trunk/release/armitage-unix /usr/local/share/armitage/
	sudo sh -c "echo java -jar /usr/local/share/armitage/armitage.jar \$\* > /usr/local/share/armitage/armitage"
	sudo ln -s /usr/local/share/armitage/armitage /usr/local/bin/armitage
	echo "alias armitage='-E armitage'" >> ~/.bash_aliases
	PRINT_ERROR "Please logout and start once Metasploit before using Armitage"
else
	cd ./armitage/
	sudo svn up | grep -o "At revision"
	if [ $? = 0 ] ; then
		PRINT_GOOD "Armitage already up-to-date"
	else
		PRINT_GOOD "Armitage updated"
	fi
	sudo sh -c "echo java -jar /usr/local/share/armitage/armitage.jar \$\* > /usr/local/share/armitage/armitage"
fi

# THC Hydra
PRINT_MESSAGE "Checking for THC Hydra updates"
# THC Hydra Dependencies
for DEPENDPKG in libssl-dev libssh-dev libidn11-dev libpcre3-dev libgtk2.0-dev libmysqlclient-dev libpq-dev libsvn-dev firebird-dev
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install THC Hydra Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done
hydra_install()
{
	PRINT_GOOD "Install THC Hydra"
	cd ./hydra/
	sudo ./configure
	make
	sudo make install clean
}

cd "${TOOLSDIRECTORY}"
if [ ! -d ./hydra/ ]; then
	PRINT_GOOD "Downloading THC Hydra"
	git clone https://github.com/vanhauser-thc/thc-hydra.git hydra
	hydra_install
else
	cd ./hydra/
	git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "THC Hydra already up-to-date"
	else
		hydra_install
		PRINT_GOOD "THC Hydra updated"
	fi

fi
