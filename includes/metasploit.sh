#!/bin/bash

# Metasploit
PACKAGE_NAME="Metasploit"
PRINT_MESSAGE "Checking for ${PACKAGE_NAME} updates"
# Metasploit Dependencies
for DEPENDPKG in build-essential libreadline-dev libssl-dev libpq5 libpq-dev libreadline5 libsqlite3-dev libpcap-dev openjdk-7-jre subversion git-core autoconf postgresql curl zlib1g-dev libxml2-dev libxslt1-dev xtightvncviewer libyaml-dev ruby-dev
do
	dpkg -s ${DEPENDPKG} 2>&1 | grep -o Installed-Size
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install ${PACKAGE_NAME} Dependency - ${DEPENDPKG}"
		sudo apt-get -y install ${DEPENDPKG}
	fi
done

for DEPENDPKG in wirble sqlite3 bundler pcaprub nokogiri
do
	gem list ${DEPENDPKG} | grep ${DEPENDPKG}
	if [ $? != 0 ] ; then
		PRINT_GOOD "Install ${PACKAGE_NAME} Gem Dependency - ${DEPENDPKG}"
		sudo gem install ${DEPENDPKG}
	fi
done

# Install Metasploit
cd /opt/
if [ ! -d ./metasploit-framework/ ]; then
	PRINT_GOOD "Downloading ${PACKAGE_NAME}"
	sudo git clone https://github.com/rapid7/metasploit-framework.git
	cd /opt/metasploit-framework/
	for MSF in $(ls msf*); do
			sudo ln -s /opt/metasploit-framework/$MSF /usr/local/bin/$MSF
	done
	bundle install

	# Stops: WARNING: Nokogiri was built against LibXML version
	sudo gem pristine nokogiri

	PRINT_QUESTION "Enter password for MSF Postgres user [ENTER]: "
	read MSFPASS

	# Creating the MSF Database user msf with the password provided
	sudo -u postgres psql postgres -c "create role msf login password '${MSFPASS}'"

	# Creating msf database and setting the owner to msf user
	sudo -u postgres psql postgres -c "CREATE DATABASE msf OWNER msf;"

	POSTGRES_PORT=$(cat /etc/postgresql/*/main/postgresql.conf | awk -F "port = " '{print $2}' | awk '{print $1}' | tr -s '\n' ' ' | tr -d ' ')
	sudo sh -c "echo 'production:
   adapter: postgresql
   database: msf
   username: msf
   password: ${MSFPASS}
   host: 127.0.0.1
   port: ${POSTGRES_PORT}
   pool: 75
   timeout: 5' > /opt/metasploit-framework/database.yml"

	sudo sh -c "echo export MSF_DATABASE_CONFIG=/opt/metasploit-framework/database.yml >> /etc/profile"

	cd /etc/postgresql/*/main/
	sudo cp ./postgresql.conf ./postgresql.conf_orig
	sudo sed -i -e 's/ssl = true/#ssl = true/g' ./postgresql.conf

	sudo cp ./pg_hba.conf ./pg_hba.conf_orig
	sudo sh -c "echo '# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   msf             msf                                     trust
# IPv4 local connections:
host    msf             msf             127.0.0.1/32            trust
# IPv6 local connections:
host    msf             msf             ::1/128                 trust
# Allow replication connections from localhost, by a user with the
# replication privilege.
#local   replication     postgres                                peer
#host    replication     postgres        127.0.0.1/32            md5
#host    replication     postgres        ::1/128                 md5
' > ./pg_hba.conf"

	sudo /etc/init.d/postgresql restart
	echo "alias msfconsole='msfconsole -x \"db_connect -y /opt/metasploit-framework/database.yml\"'" >> ~/.bashrc
	PRINT_ERROR "Please logout before using ${PACKAGE_NAME}"
else
	cd ./metasploit-framework/
	sudo git pull | grep -o "Already up-to-date"
	if [ $? = 0 ] ; then
		PRINT_GOOD "${PACKAGE_NAME} already up-to-date"
	else
		# Update any missing Gems
		sudo bundle install
		PRINT_GOOD "${PACKAGE_NAME} updated"
	fi
fi